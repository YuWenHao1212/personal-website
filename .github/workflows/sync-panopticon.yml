name: Sync Panopticon Data

on:
  schedule:
    # Sync after X discovery runs (add 5 min buffer)
    - cron: '5 22 * * *'   # 6:05 AM Taiwan (after X 6AM)
    - cron: '5 4 * * *'    # 12:05 PM Taiwan (after X 12PM)
    - cron: '5 8 * * *'    # 4:05 PM Taiwan (after X 4PM)
    - cron: '5 12 * * *'   # 8:05 PM Taiwan (after X 8PM)
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force refresh even if data exists'
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up date and hour
        id: datetime
        run: |
          echo "TODAY=$(TZ='Asia/Taipei' date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          # Determine which X batch to fetch based on current hour
          CURRENT_HOUR=$(TZ='Asia/Taipei' date +%H)
          if [ "$CURRENT_HOUR" -lt 9 ]; then
            echo "X_HOUR=06" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_HOUR" -lt 15 ]; then
            echo "X_HOUR=12" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_HOUR" -lt 19 ]; then
            echo "X_HOUR=16" >> $GITHUB_OUTPUT
          else
            echo "X_HOUR=20" >> $GITHUB_OUTPUT
          fi

      - name: Fetch Reddit/HN/PH data from Cockpit
        env:
          COCKPIT_TOKEN: ${{ secrets.COCKPIT_REPO_TOKEN }}
        run: |
          mkdir -p public/data/panopticon

          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/content.json \
            -H "Authorization: token $COCKPIT_TOKEN" \
            -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/YuWenHao1212/Cockpit/contents/briefs/content/${{ steps.datetime.outputs.TODAY }}.json")

          if [ "$HTTP_CODE" = "200" ]; then
            cp /tmp/content.json public/data/panopticon/latest.json
            cp /tmp/content.json "public/data/panopticon/${{ steps.datetime.outputs.TODAY }}.json"
            echo "Fetched content data for ${{ steps.datetime.outputs.TODAY }}"
          else
            echo "No content data available (HTTP $HTTP_CODE)"
            if [ ! -f public/data/panopticon/latest.json ]; then
              echo '{"date":"${{ steps.datetime.outputs.TODAY }}","stats":{"total_items":0},"items":[]}' > public/data/panopticon/latest.json
            fi
          fi

      - name: Fetch X data from Cockpit
        env:
          COCKPIT_TOKEN: ${{ secrets.COCKPIT_REPO_TOKEN }}
        run: |
          mkdir -p public/data/panopticon/x

          HTTP_CODE=$(curl -s -w "%{http_code}" -o /tmp/x.json \
            -H "Authorization: token $COCKPIT_TOKEN" \
            -H "Accept: application/vnd.github.v3.raw" \
            "https://api.github.com/repos/YuWenHao1212/Cockpit/contents/briefs/x/${{ steps.datetime.outputs.TODAY }}-${{ steps.datetime.outputs.X_HOUR }}.json")

          if [ "$HTTP_CODE" = "200" ]; then
            cp /tmp/x.json public/data/panopticon/x/latest.json
            cp /tmp/x.json "public/data/panopticon/x/${{ steps.datetime.outputs.TODAY }}-${{ steps.datetime.outputs.X_HOUR }}.json"
            echo "Fetched X data for ${{ steps.datetime.outputs.TODAY }}-${{ steps.datetime.outputs.X_HOUR }}"
          else
            echo "No X data available (HTTP $HTTP_CODE)"
            if [ ! -f public/data/panopticon/x/latest.json ]; then
              echo '{"date":"","hour":"","stats":{"total_fetched":0,"total_items":0,"analyzed_items":0},"items":[]}' > public/data/panopticon/x/latest.json
            fi
          fi

      - name: Commit and push
        id: commit
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add public/data/panopticon/
          if git diff --staged --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
          else
            git commit -m "chore: sync panopticon data for ${{ steps.datetime.outputs.TODAY }}"
            git push
            echo "changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger Azure deployment
        if: steps.commit.outputs.changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.COCKPIT_REPO_TOKEN }}
        run: |
          gh workflow run "Azure Static Web Apps CI/CD" --repo YuWenHao1212/personal-website
