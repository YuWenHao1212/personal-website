---
import { getCollection } from 'astro:content';
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { getRelatedPosts } from '../utils/relatedPosts';
import { categoryNames } from '../i18n/categories';
import type { CollectionEntry } from 'astro:content';
import type { Lang } from '../i18n/ui';

interface Props {
  currentPost: CollectionEntry<'blog'>;
}

const { currentPost } = Astro.props;

const lang = getLangFromUrl(Astro.url) as Lang;
const t = useTranslations(lang);

// Get all posts (exclude drafts)
const allPosts = await getCollection('blog', ({ data }) => data.draft !== true);

// Get related posts
const relatedPosts = getRelatedPosts({
  currentPost,
  allPosts,
  limit: 3,
});

function formatDate(date: Date): string {
  return date.toLocaleDateString(lang === 'zh-TW' ? 'zh-TW' : 'en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}

// Category colors for placeholder backgrounds
const categoryColors: Record<string, string> = {
  'building-products': 'from-blue-100 to-blue-50',
  'productivity': 'from-green-100 to-green-50',
  'life-learning': 'from-purple-100 to-purple-50',
};

// Category icons
const categoryIcons: Record<string, string> = {
  'building-products': 'ðŸš€',
  'productivity': 'âš¡',
  'life-learning': 'ðŸŒ±',
};
---

{relatedPosts.length > 0 && (
  <section class="mt-12 pt-8 border-t border-cream-200">
    <h2 class="text-lg md:text-xl font-semibold text-ink-900 mb-6">
      {lang === 'zh-TW' ? 'ç›¸é—œæ–‡ç« ' : 'Related Posts'}
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      {relatedPosts.map((post) => (
        <a
          href={`/${lang}/blog/${post.id.split('/').pop()}/`}
          class="group block bg-cream-50 rounded-lg overflow-hidden hover:bg-cream-100 transition-colors"
        >
          <!-- Image or Placeholder -->
          <div class="relative h-32 overflow-hidden">
            {post.data.heroImage ? (
              <img
                src={post.data.heroImage}
                alt={post.data.title}
                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
              />
            ) : (
              <div class={`w-full h-full bg-gradient-to-br ${categoryColors[post.data.category]} flex items-center justify-center`}>
                <span class="text-3xl opacity-60">
                  {categoryIcons[post.data.category]}
                </span>
              </div>
            )}
          </div>
          <!-- Content -->
          <div class="p-4">
            <span class="text-xs font-medium text-accent">
              {categoryNames[post.data.category][lang]}
            </span>
            <h3 class="mt-1 text-sm md:text-base font-medium text-ink-900 group-hover:text-accent transition-colors line-clamp-2">
              {post.data.title}
            </h3>
            <time class="mt-2 block text-xs text-ink-400">
              {formatDate(post.data.pubDate)}
            </time>
          </div>
        </a>
      ))}
    </div>
  </section>
)}
