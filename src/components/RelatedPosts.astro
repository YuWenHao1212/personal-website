---
import { getCollection } from 'astro:content';
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import { getRelatedPosts } from '../utils/relatedPosts';
import { categoryNames } from '../i18n/categories';
import type { CollectionEntry } from 'astro:content';
import type { Lang } from '../i18n/ui';

interface Props {
  currentPost: CollectionEntry<'blog'>;
}

const { currentPost } = Astro.props;

const lang = getLangFromUrl(Astro.url) as Lang;
const t = useTranslations(lang);

// Get all posts
const allPosts = await getCollection('blog');

// Get related posts
const relatedPosts = getRelatedPosts({
  currentPost,
  allPosts,
  limit: 3,
});

function formatDate(date: Date): string {
  return date.toLocaleDateString(lang === 'zh-TW' ? 'zh-TW' : 'en-US', {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
  });
}
---

{relatedPosts.length > 0 && (
  <section class="mt-12 pt-8 border-t border-cream-200">
    <h2 class="text-lg md:text-xl font-semibold text-ink-900 mb-6">
      {lang === 'zh-TW' ? '相關文章' : 'Related Posts'}
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      {relatedPosts.map((post) => (
        <a
          href={`/${lang}/blog/${post.id.split('/').pop()}`}
          class="group block p-4 bg-cream-50 rounded-lg hover:bg-cream-100 transition-colors"
        >
          <span class="text-xs font-medium text-accent">
            {categoryNames[post.data.category][lang]}
          </span>
          <h3 class="mt-1 text-sm md:text-base font-medium text-ink-900 group-hover:text-accent transition-colors line-clamp-2">
            {post.data.title}
          </h3>
          <time class="mt-2 block text-xs text-ink-400">
            {formatDate(post.data.pubDate)}
          </time>
        </a>
      ))}
    </div>
  </section>
)}
