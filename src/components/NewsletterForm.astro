---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
  variant?: 'default' | 'compact';
}

const { variant = 'default' } = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const thankYouUrl = `/${lang}/thank-you`;
---

<section class:list={[
  variant === 'default' ? 'py-10 md:py-14 lg:py-16 bg-cream-200' : 'py-6 md:py-8',
]}>
  <div class:list={[
    variant === 'default' ? 'container-narrow text-center' : '',
  ]}>
    {variant === 'default' && (
      <>
        <h2 class="text-xl md:text-2xl lg:text-3xl font-bold text-ink-900 mb-3 md:mb-4">
          {t('newsletter.title')}
        </h2>
        <p class="text-sm md:text-base text-ink-600 mb-6 md:mb-8 max-w-md mx-auto">
          {t('newsletter.description')}
        </p>
      </>
    )}

    <form
      id="newsletter-form"
      class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto"
      data-umami-event="newsletter_signup"
      data-thank-you-url={thankYouUrl}
    >
      <input
        type="email"
        name="email_address"
        placeholder={t('newsletter.placeholder')}
        required
        class="flex-1 px-4 py-2.5 md:py-3 rounded-lg border border-cream-300 bg-white text-sm md:text-base text-ink-900 placeholder-ink-400 focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
      />
      <button
        type="submit"
        class="btn-primary text-sm md:text-base whitespace-nowrap"
      >
        {t('newsletter.button')}
      </button>
    </form>

    <script>
      const form = document.getElementById('newsletter-form') as HTMLFormElement;

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const thankYouUrl = form.dataset.thankYouUrl || '/zh-TW/thank-you';

        try {
          await fetch('https://app.kit.com/forms/8951335/subscriptions', {
            method: 'POST',
            body: formData,
            mode: 'no-cors'
          });

          window.location.href = thankYouUrl;
        } catch (error) {
          console.error('Newsletter subscription failed:', error);
          window.location.href = thankYouUrl;
        }
      });
    </script>

    <p class="mt-3 md:mt-4 text-xs md:text-sm text-ink-500">
      {t('newsletter.privacy')}
    </p>
  </div>
</section>
