---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

interface Props {
  variant?: 'default' | 'compact';
}

const { variant = 'default' } = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const thankYouUrl = `/${lang}/thank-you`;
---

<section class:list={[
  variant === 'default' ? 'py-24 md:py-32 bg-[#FFFDF9]' : 'py-6 md:py-8',
]}>
  <div class:list={[
    variant === 'default' ? 'max-w-6xl mx-auto px-6' : '',
  ]}>
    {variant === 'default' && lang === 'zh-TW' && (
      <div class="max-w-2xl mx-auto text-center">
        <h2 class="text-[2rem] md:text-[2.5rem] font-bold text-[#2C2416] leading-[1.1] tracking-[-0.02em] mb-4">
          {t('newsletter.title')}
        </h2>
        <p class="text-lg text-[#5C5144] mb-10">
          {t('newsletter.description')}
        </p>

        <form
          id="newsletter-form"
          class="flex flex-col sm:flex-row gap-4"
          data-umami-event="newsletter_signup"
          data-thank-you-url={thankYouUrl}
        >
          <label for="newsletter-email-default" class="sr-only">
            {t('newsletter.placeholder')}
          </label>
          <input
            id="newsletter-email-default"
            type="email"
            name="email_address"
            placeholder={t('newsletter.placeholder')}
            required
            class="flex-1 px-5 py-4 border-2 border-[#2C2416] bg-[#FFFDF9] text-[#2C2416] placeholder-[#8B7355] focus:outline-none focus:ring-0 text-base"
          />
          <button
            type="submit"
            class="px-8 py-4 bg-[#2C2416] text-[#FAF8F5] text-base font-medium hover:bg-[#3D3220] transition-colors whitespace-nowrap"
          >
            {t('newsletter.button')}
          </button>
        </form>

        <p class="mt-6 text-sm text-[#8B7355]">
          {t('newsletter.privacy')}
        </p>
      </div>
    )}

    {variant === 'default' && lang === 'en' && (
      <div class="max-w-2xl mx-auto text-center">
        <h2 class="text-[2rem] md:text-[2.5rem] font-bold text-[#2C2416] leading-[1.1] tracking-[-0.02em] mb-4">
          Stay Connected
        </h2>
        <p class="text-lg text-[#5C5144] mb-10">
          I'm always open to interesting conversations and opportunities â€” connect on LinkedIn, or explore the blog.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a
            href="https://www.linkedin.com/in/hence/"
            target="_blank"
            rel="noopener noreferrer"
            class="px-8 py-4 bg-[#2C2416] text-[#FAF8F5] text-base font-medium hover:bg-[#3D3220] transition-colors text-center"
          >
            Connect on LinkedIn
          </a>
          <a
            href="/en/blog/"
            class="px-8 py-4 border-2 border-[#2C2416] text-[#2C2416] text-base font-medium hover:bg-[#2C2416] hover:text-[#FAF8F5] transition-colors text-center"
          >
            Read the Blog
          </a>
        </div>
      </div>
    )}

    {variant === 'compact' && (
      <form
        id="newsletter-form-compact"
        class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto"
        data-umami-event="newsletter_signup"
        data-thank-you-url={thankYouUrl}
      >
        <label for="newsletter-email-compact" class="sr-only">
          {t('newsletter.placeholder')}
        </label>
        <input
          id="newsletter-email-compact"
          type="email"
          name="email_address"
          placeholder={t('newsletter.placeholder')}
          required
          class="flex-1 px-4 py-3 rounded-lg border border-cream-300 bg-white text-ink-900 placeholder-ink-400 focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent"
        />
        <button
          type="submit"
          class="btn-primary whitespace-nowrap"
        >
          {t('newsletter.button')}
        </button>
      </form>
    )}

    <script>
      const forms = document.querySelectorAll('[id^="newsletter-form"]') as NodeListOf<HTMLFormElement>;

      forms.forEach(form => {
        form?.addEventListener('submit', async (e) => {
          e.preventDefault();

          const formData = new FormData(form);
          const thankYouUrl = form.dataset.thankYouUrl || '/zh-TW/thank-you';

          try {
            await fetch('https://app.kit.com/forms/8951335/subscriptions', {
              method: 'POST',
              body: formData,
              mode: 'no-cors'
            });

            window.location.href = thankYouUrl;
          } catch (error) {
            console.error('Newsletter subscription failed:', error);
            window.location.href = thankYouUrl;
          }
        });
      });
    </script>
  </div>
</section>
